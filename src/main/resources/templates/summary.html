<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Resumen de Indisponibilidad</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/date-fns@2.30.0/dist/date-fns.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 2rem; }
    #chartContainer { width: 80%; margin: auto; height: 400px; }
    #chartContainer canvas { cursor: pointer; }
    #datePickerContainer { text-align: center; margin-bottom: 1.5rem; }
  </style>
</head>

<body>
  <h1>Gráfico de % Indisponibilidad por Día</h1>
  <p>Seleccione una fecha y haga clic en un punto para ver el detalle del reporte o sobre una hora para filtrar ±30 min.</p>

  <div id="datePickerContainer">
    <label for="datePicker">Seleccionar día:</label>
    <input type="date" id="datePicker" />
  </div>

  <div id="chartContainer">
    <canvas id="summaryChart"></canvas>
  </div>

  <button id="backBtn" style="display:none; margin: 1rem auto; display: block;" onclick="resetToDailyView()">Volver al resumen diario</button>

  <script>
    let previousScrollY = 0;
    let previousScrollX = 0;
    const summaryData = [
      {#each summaries}
        {
          reportName: "{it.name}",
          percentage: {it.summaryPercentage},
          uploadTime: "{it.uploadTime}"
        }{#if !it_isLast},{/if}
      {/each}
    ];
    console.log("summaryData:", summaryData);

    let currentDate = null;
    let chart;

    const chartCanvas = document.getElementById('summaryChart');
    const backBtn = document.getElementById('backBtn');

    if (summaryData.length === 0) {
      document.getElementById('chartContainer').innerHTML =
        '<div style="text-align:center;color:#666;padding:2rem;">No hay reportes disponibles.</div>';
    } else {
      const uniqueDates = [...new Set(summaryData.map(d =>
        new Date(d.uploadTime).toISOString().split('T')[0]
      ))];

      const datePicker = document.getElementById('datePicker');
      const today = new Date().toISOString().split('T')[0];
      const minDate = uniqueDates[0];
      const maxDate = uniqueDates[uniqueDates.length - 1];
      datePicker.min = minDate;
      datePicker.max = maxDate;
      const defaultDate = uniqueDates.includes(today) ? today : minDate;
      datePicker.value = defaultDate;
      currentDate = defaultDate;

      function renderChart(data, title) {
        if (chart) chart.destroy();
        const ctx = chartCanvas.getContext('2d');

        chart = new Chart(ctx, {
          type: 'line',
          data: {
            datasets: [{
              label: title,
              data: data.map(d => ({
                x: d.uploadTime,
                y: d.percentage,
                reportName: d.reportName
              })),
              fill: false,
              borderColor: 'red',
              backgroundColor: 'rgba(255,0,0,0.2)',
              borderWidth: 2,
              pointRadius: 5,
              tension: 0.3
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            onClick: (evt, elements) => {
              if (elements.length > 0) {
                const idx = elements[0].index;
                const name = chart.data.datasets[0].data[idx].reportName;
                window.location.href = '/report-detail?name=' + encodeURIComponent(name);
              }
            },
            scales: {
              x: {
                type: 'time',
                time: {
                  unit: 'minute',
                  displayFormats: { minute: 'HH:mm' }
                },
                title: { display: true, text: 'Hora' }
              },
              y: {
                beginAtZero: true,
                suggestedMax: Math.max(...data.map(d => d.percentage), 10),
                title: { display: true, text: '% Indisponibilidad' }
              }
            },
            plugins: {
              title: {
                display: true,
                text: title
              }
            }
          }
        });

        // Clic en etiqueta de hora (eje X) -> filtrar ±30 min
        chartCanvas.onclick = function (evt) {
          const points = chart.getElementsAtEventForMode(evt, 'nearest', { intersect: false }, true);
          if (points.length > 0) return; // ya manejado

          const xScale = chart.scales.x;
          const xValue = xScale.getValueForPixel(evt.offsetX);
          if (!xValue) return;

          const selectedTime = new Date(xValue);
          const minTime = new Date(selectedTime.getTime() - 30 * 60 * 1000);
          const maxTime = new Date(selectedTime.getTime() + 30 * 60 * 1000);

          const filtered = summaryData.filter(d => {
            const t = new Date(d.uploadTime);
            return t >= minTime && t <= maxTime;
          });

          if (filtered.length > 0) {
            previousScrollY = window.scrollY;
            previousScrollX = window.scrollX;
            renderChart(filtered, "±30min desde " + selectedTime.getHours() + ":00");
            backBtn.style.display = 'block';
          }
        };
      }

      function resetToDailyView() {
        renderChartForDate(currentDate);
        backBtn.style.display = 'none';
        window.scrollTo(previousScrollX, previousScrollY);
      }

      function renderChartForDate(date) {
        currentDate = date;
        const filtered = summaryData.filter(d =>
          d.uploadTime.startsWith(date)
        ).sort((a, b) => new Date(a.uploadTime) - new Date(b.uploadTime));

        renderChart(filtered, "% Indisponibilidad – " + date);
      }

      datePicker.addEventListener('change', () => {
        renderChartForDate(datePicker.value);
        backBtn.style.display = 'none';
      });

      renderChartForDate(defaultDate);
    }
  </script>
</body>
</html>
